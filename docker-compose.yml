services:
  # Base de donn√©es MySQL
  mysql:
    image: mysql:8
    container_name: eventtickets-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: eventtickets_users
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - eventtickets-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  rabbitmq:
    image: rabbitmq:4-management
    container_name: rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672" 
      - "15672:15672" 
    networks:
      - eventtickets-network

  # User Service (Node.js + Prisma)
  user-service:
    build:
      context: ./user-service
    container_name: eventtickets-user-service
    restart: unless-stopped
    environment:
      DATABASE_URL: mysql://root:root@mysql:3306/eventtickets_users
      JWT_SECRET: dev_secret_key_changez_moi_en_production_2024
      JWT_REFRESH_SECRET: dev_refresh_secret_key_changez_moi_en_production_2024
      PORT: 3001
      NODE_ENV: production
    ports:
      - "3001:3001"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - eventtickets-network
    command: sh -c "npx prisma migrate deploy && npx prisma db seed && npm start"

  # Event Catalog Service (Spring Boot)
  event-catalog-service:
    build:
      context: ./EventCatalogService
    container_name: eventtickets-event-catalog
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/eventtickets_events?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SERVER_PORT: 8080
    ports:
      - "8080:8080"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - eventtickets-network

  # Ticket Inventory Service (Spring Boot)
  ticket-inventory-service:
    build:
      context: ./TicketInventoryService
    container_name: eventtickets-inventory
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/ticket_inventory?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SERVER_PORT: 8082
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      EVENTCATALOG_SERVICE_URL: http://event-catalog-service:8080
    ports:
      - "8082:8082"
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - eventtickets-network

  # Payment and Notification Service (Laravel/PHP)
  payment-service:
    build:
      context: ./paymentAndNotificationService
    container_name: eventtickets-payment
    restart: unless-stopped
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: eventtickets_payments
      DB_USERNAME: root
      DB_PASSWORD: root
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
    ports:
      - "8083:8000"
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    networks:
      - eventtickets-network
    command: sh -c "php artisan migrate --force && php artisan serve --host=0.0.0.0 --port=8000"

  # API Gateway (Node.js + Express)
  api-gateway:
    build:
      context: ./api-gateway
    container_name: eventtickets-gateway
    restart: unless-stopped
    environment:
      PORT: 3000
      NODE_ENV: production
      JWT_SECRET: dev_secret_key_changez_moi_en_production_2024
      USER_SERVICE_URL: http://user-service:3001
      EVENT_CATALOG_SERVICE_URL: http://event-catalog-service:8080
      TICKET_INVENTORY_SERVICE_URL: http://ticket-inventory-service:8082
      PAYMENT_SERVICE_URL: http://payment-service:8000
      CORS_ORIGIN: http://localhost:5173
    ports:
      - "3000:3000"
    depends_on:
      - user-service
      - event-catalog-service
      - ticket-inventory-service
      - payment-service
    networks:
      - eventtickets-network

  # Frontend Web (React + Vite)
  web:
    build:
      context: ./web
    container_name: eventtickets-web
    restart: unless-stopped
    environment:
      VITE_API_GATEWAY_URL: http://localhost:3000
      VITE_API_USER_URL: http://localhost:3001/api
      VITE_API_CATALOG_URL: http://localhost:8080/events
    ports:
      - "5173:80"
    depends_on:
      - api-gateway
    volumes:
      - ./web:/app
    networks:
      - eventtickets-network

volumes:
  mysql-data:
    driver: local

networks:
  eventtickets-network:
    driver: bridge
