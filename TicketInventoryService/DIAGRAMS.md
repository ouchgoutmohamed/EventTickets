# ğŸ“ Diagrammes Architecture - Ticket Inventory Service

## ğŸ—ï¸ Architecture 4 Couches

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLIENT HTTP                              â”‚
â”‚         (Browser, Mobile App, Postman, etc.)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CONTROLLER LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         TicketController                             â”‚  â”‚
â”‚  â”‚  @RestController @RequestMapping("/tickets")         â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  - reserve(@Valid ReserveRequest)                    â”‚  â”‚
â”‚  â”‚  - confirm(@Valid ConfirmRequest)                    â”‚  â”‚
â”‚  â”‚  - release(@Valid ReleaseRequest)                    â”‚  â”‚
â”‚  â”‚  - getAvailability(eventId)                          â”‚  â”‚
â”‚  â”‚  - getUserReservations(userId)                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Injection Constructeur
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SERVICE LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      TicketInventoryService                          â”‚  â”‚
â”‚  â”‚  @Service @Transactional                             â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  + reserveTickets(request, idempotencyKey)           â”‚  â”‚
â”‚  â”‚  + confirmReservation(request)                       â”‚  â”‚
â”‚  â”‚  + releaseReservation(request)                       â”‚  â”‚
â”‚  â”‚  + getAvailability(eventId)                          â”‚  â”‚
â”‚  â”‚  + getUserReservations(userId)                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    ReservationCleanupService                         â”‚  â”‚
â”‚  â”‚  @Service @Scheduled                                 â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  + cleanupExpiredReservations() [Cron: */5 min]     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 REPOSITORY LAYER                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Inventory      â”‚  â”‚ Reservation    â”‚  â”‚ Ticket       â”‚  â”‚
â”‚  â”‚ Repository     â”‚  â”‚ Repository     â”‚  â”‚ Repository   â”‚  â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ - findById     â”‚  â”‚ - findById     â”‚  â”‚ - findById   â”‚  â”‚
â”‚  â”‚ - findByIdWith â”‚  â”‚ - findByUserId â”‚  â”‚ - findByUser â”‚  â”‚
â”‚  â”‚   Lock         â”‚  â”‚ - findByIdem   â”‚  â”‚   Id         â”‚  â”‚
â”‚  â”‚   (Pessimistic)â”‚  â”‚   potencyKey   â”‚  â”‚ - findByRes  â”‚  â”‚
â”‚  â”‚                â”‚  â”‚ - findExpired  â”‚  â”‚   ervationId â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Spring Data JPA
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DOMAIN LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Inventory  â”‚   â”‚ Reservation  â”‚   â”‚   Ticket     â”‚      â”‚
â”‚  â”‚ @Entity    â”‚   â”‚ @Entity      â”‚   â”‚   @Entity    â”‚      â”‚
â”‚  â”‚            â”‚   â”‚              â”‚   â”‚              â”‚      â”‚
â”‚  â”‚ eventId PK â”‚   â”‚ id (auto)    â”‚   â”‚ id (auto)    â”‚      â”‚
â”‚  â”‚ total      â”‚   â”‚ eventId      â”‚   â”‚ reservationIdâ”‚      â”‚
â”‚  â”‚ reserved   â”‚   â”‚ userId       â”‚   â”‚ userId       â”‚      â”‚
â”‚  â”‚ version    â”‚   â”‚ quantity     â”‚   â”‚ eventId      â”‚      â”‚
â”‚  â”‚            â”‚   â”‚ status (enum)â”‚   â”‚ quantity     â”‚      â”‚
â”‚  â”‚ getAvail() â”‚   â”‚ holdExpires  â”‚   â”‚ createdAt    â”‚      â”‚
â”‚  â”‚ @Transient â”‚   â”‚ idempotency  â”‚   â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Hibernate/JPA
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DATABASE (MySQL)                         â”‚
â”‚  Tables: inventory, reservation, ticket                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flux de RÃ©servation

### 1. RÃ©servation de Tickets

```
Client                Controller           Service              Repository          DB
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚â”€POST /reserveâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                      â”‚              â”‚
  â”‚  {eventId:1,          â”‚                   â”‚                      â”‚              â”‚
  â”‚   userId:42,          â”‚                   â”‚                      â”‚              â”‚
  â”‚   quantity:2}         â”‚                   â”‚                      â”‚              â”‚
  â”‚  Idempotency-Key:xxx  â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚â”€â”€reserve()â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚â”€â”€findByIdempotencyâ”€>â”‚              â”‚
  â”‚                       â”‚                   â”‚     (vÃ©rif dupli)    â”‚â”€â”€SELECTâ”€â”€â”€â”€>â”‚
  â”‚                       â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚â”€â”€findByIdWithLockâ”€â”€>â”‚              â”‚
  â”‚                       â”‚                   â”‚   (PESSIMISTIC)      â”‚â”€â”€SELECT FORâ”€>â”‚
  â”‚                       â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  UPDATE      â”‚
  â”‚                       â”‚                   â”‚   Inventory(100,10)  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚â”€â”€save(inventory)â”€â”€â”€â”€>â”‚              â”‚
  â”‚                       â”‚                   â”‚   reserved=12        â”‚â”€â”€UPDATEâ”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚â”€â”€save(reservation)â”€â”€>â”‚              â”‚
  â”‚                       â”‚                   â”‚   status=PENDING     â”‚â”€â”€INSERTâ”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                   â”‚   expires=now+15min  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  id=123      â”‚
  â”‚                       â”‚                   â”‚   Reservation(123)   â”‚              â”‚
  â”‚                       â”‚<â”€â”€ReserveRespâ”€â”€â”€â”€â”‚                      â”‚              â”‚
  â”‚<â”€â”€200 OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   {id:123,       â”‚                      â”‚              â”‚
  â”‚  {reservationId:123,  â”‚    status:PENDINGâ”‚                      â”‚              â”‚
  â”‚   status:"PENDING",   â”‚    expires:...}  â”‚                      â”‚              â”‚
  â”‚   holdExpiresAt:...}  â”‚                   â”‚                      â”‚              â”‚
```

### 2. Confirmation de RÃ©servation

```
Client                Controller           Service              Repository          DB
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚â”€POST /confirmâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                      â”‚              â”‚
  â”‚  {reservationId:123}  â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚â”€â”€confirm()â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚â”€â”€findById(123)â”€â”€â”€â”€â”€>â”‚              â”‚
  â”‚                       â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€SELECTâ”€â”€â”€â”€>â”‚
  â”‚                       â”‚                   â”‚   Reservation(PEND)  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚â”€â”€VÃ©rif expirationâ”€â”€â”€â”‚              â”‚
  â”‚                       â”‚                   â”‚   (now < holdExpires)â”‚              â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚â”€â”€save(reservation)â”€â”€>â”‚              â”‚
  â”‚                       â”‚                   â”‚   status=CONFIRMED   â”‚â”€â”€UPDATEâ”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚                   â”‚                      â”‚              â”‚
  â”‚                       â”‚                   â”‚â”€â”€save(ticket)â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
  â”‚                       â”‚                   â”‚   Ticket(qty=2)      â”‚â”€â”€INSERTâ”€â”€â”€â”€â”€>â”‚
  â”‚                       â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                       â”‚<â”€â”€ConfirmRespâ”€â”€â”€â”€â”‚                      â”‚              â”‚
  â”‚<â”€â”€200 OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   {status:CONF}  â”‚                      â”‚              â”‚
  â”‚  {status:"CONFIRMED"} â”‚                   â”‚                      â”‚              â”‚
```

### 3. Nettoyage Automatique (Scheduled)

```
Scheduler         Service              Repository          DB
  â”‚                   â”‚                      â”‚              â”‚
  â”‚â”€Cron: */5 minâ”€â”€â”€â”€>â”‚                      â”‚              â”‚
  â”‚                   â”‚                      â”‚              â”‚
  â”‚                   â”‚â”€â”€cleanup()          â”‚              â”‚
  â”‚                   â”‚                      â”‚              â”‚
  â”‚                   â”‚â”€â”€findExpired()â”€â”€â”€â”€â”€>â”‚              â”‚
  â”‚                   â”‚   (PENDING, now)     â”‚â”€â”€SELECTâ”€â”€â”€â”€>â”‚
  â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  WHERE statusâ”‚
  â”‚                   â”‚   [Res(id=99), ...]  â”‚  AND expiresâ”‚
  â”‚                   â”‚                      â”‚  < now       â”‚
  â”‚                   â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                   â”‚                      â”‚              â”‚
  â”‚                   â”‚â”€â”€Pour chaque:       â”‚              â”‚
  â”‚                   â”‚                      â”‚              â”‚
  â”‚                   â”‚  â”€â”€findById(event)â”€>â”‚              â”‚
  â”‚                   â”‚  <â”€Inventoryâ”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€SELECTâ”€â”€â”€â”€>â”‚
  â”‚                   â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                   â”‚                      â”‚              â”‚
  â”‚                   â”‚  â”€â”€save(inventory)â”€>â”‚              â”‚
  â”‚                   â”‚    reserved-=qty     â”‚â”€â”€UPDATEâ”€â”€â”€â”€â”€>â”‚
  â”‚                   â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                   â”‚                      â”‚              â”‚
  â”‚                   â”‚  â”€â”€save(reserv)â”€â”€â”€â”€>â”‚              â”‚
  â”‚                   â”‚    status=EXPIRED    â”‚â”€â”€UPDATEâ”€â”€â”€â”€â”€>â”‚
  â”‚                   â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                   â”‚                      â”‚              â”‚
  â”‚                   â”‚â”€â”€Log: N expired     â”‚              â”‚
```

---

## ğŸ”’ Gestion de la Concurrence

### Scenario: 2 utilisateurs rÃ©servent simultanÃ©ment

```
User A                User B              Service              DB (Inventory)
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚â”€Reserve 5 ticketsâ”€â”€>â”‚                   â”‚                      â”‚
  â”‚                     â”‚â”€Reserve 3 tickets>â”‚                      â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚â”€â”€findByIdWithLock(1)â”€>
  â”‚                     â”‚                   â”‚   PESSIMISTIC_WRITE  â”‚
  â”‚                     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                   â”‚   Inventory(total=10,â”‚
  â”‚                     â”‚                   â”‚            reserved=0)â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚   VÃ©rif: 5 <= 10 âœ…  â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚â”€â”€save(reserved=5)â”€â”€â”€>â”‚
  â”‚                     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚<â”€â”€OK: RÃ©servation A â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚â”€â”€findByIdWithLock(1)â”€>
  â”‚                     â”‚                   â”‚   (ATTEND le lock)   â”‚
  â”‚                     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                   â”‚   Inventory(total=10,â”‚
  â”‚                     â”‚                   â”‚            reserved=5)â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚   VÃ©rif: 3 <= 5 âœ…   â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚â”€â”€save(reserved=8)â”€â”€â”€>â”‚
  â”‚                     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚<â”€â”€OK: RÃ©servation B                      â”‚
```

**Sans lock pessimiste** â†’ Race condition â†’ Overbooking âŒ  
**Avec lock pessimiste** â†’ SÃ©quentialisÃ© â†’ Stock cohÃ©rent âœ…

---

## ğŸ›¡ï¸ Gestion des Erreurs

### Flow d'Exception

```
Client              Controller          Service             Exception Handler
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚â”€POST /reserveâ”€â”€â”€â”€â”€â”€>â”‚                   â”‚                      â”‚
  â”‚  {eventId:999}      â”‚                   â”‚                      â”‚
  â”‚                     â”‚â”€â”€reserve()â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
  â”‚                     â”‚                   â”‚â”€â”€findById(999)      â”‚
  â”‚                     â”‚                   â”‚   â†’ Empty           â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚â”€â”€throw Inventory    â”‚
  â”‚                     â”‚                   â”‚   NotFoundException â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚â”€â”€â”€Exceptionâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚                   â”‚        @ExceptionHandler
  â”‚                     â”‚                   â”‚        (InventoryNot...)
  â”‚                     â”‚                   â”‚                      â”‚
  â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚<â”€â”€404 NOT FOUNDâ”€â”€â”€â”€â”€â”‚                   â”‚                      â”‚
  â”‚  {                  â”‚                   â”‚                      â”‚
  â”‚    "timestamp": "...",                  â”‚                      â”‚
  â”‚    "status": 404,   â”‚                   â”‚                      â”‚
  â”‚    "error": "Inventory Not Found",      â”‚                      â”‚
  â”‚    "message": "Inventaire non trouvÃ© pour l'Ã©vÃ©nement: 999",  â”‚
  â”‚    "eventId": 999   â”‚                   â”‚                      â”‚
  â”‚  }                  â”‚                   â”‚                      â”‚
```

---

## ğŸ“¦ Structure Package

```
com.acme.tickets/
â”‚
â”œâ”€â”€ TicketInventoryApplication.java       â† Main, @EnableScheduling
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ OpenApiConfig.java                â† Swagger/OpenAPI
â”‚   â””â”€â”€ SecurityConfig.java               â† Spring Security (dev mode)
â”‚
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ TicketController.java             â† REST endpoints
â”‚
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ TicketInventoryService.java       â† Logique mÃ©tier
â”‚   â””â”€â”€ ReservationCleanupService.java    â† Scheduled tasks
â”‚
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ Inventory.java                â† @Entity + @Version
â”‚   â”‚   â”œâ”€â”€ Reservation.java              â† @Entity + indexes
â”‚   â”‚   â””â”€â”€ Ticket.java                   â† @Entity
â”‚   â”‚
â”‚   â”œâ”€â”€ enums/
â”‚   â”‚   â””â”€â”€ ReservationStatus.java        â† PENDING, CONFIRMED, etc.
â”‚   â”‚
â”‚   â””â”€â”€ repository/
â”‚       â”œâ”€â”€ InventoryRepository.java      â† Spring Data JPA
â”‚       â”œâ”€â”€ ReservationRepository.java    â† Queries custom
â”‚       â””â”€â”€ TicketRepository.java
â”‚
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ ReserveRequest.java               â† record + @Valid
â”‚   â”œâ”€â”€ ReserveResponse.java
â”‚   â”œâ”€â”€ ConfirmRequest.java
â”‚   â”œâ”€â”€ ConfirmResponse.java
â”‚   â”œâ”€â”€ ReleaseRequest.java
â”‚   â”œâ”€â”€ ReleaseResponse.java
â”‚   â”œâ”€â”€ AvailabilityResponse.java
â”‚   â”œâ”€â”€ UserReservationsResponse.java
â”‚   â””â”€â”€ UserReservationsItem.java
â”‚
â””â”€â”€ exception/
    â”œâ”€â”€ GlobalExceptionHandler.java       â† @RestControllerAdvice
    â”œâ”€â”€ ReservationNotFoundException.java
    â”œâ”€â”€ InsufficientStockException.java
    â”œâ”€â”€ ReservationExpiredException.java
    â”œâ”€â”€ InvalidReservationStateException.java
    â””â”€â”€ InventoryNotFoundException.java
```

---

## ğŸ—„ï¸ ModÃ¨le de DonnÃ©es

```sql
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      INVENTORY          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ event_id (PK)           â”‚â”€â”€â”€â”
â”‚ total                   â”‚   â”‚
â”‚ reserved                â”‚   â”‚
â”‚ version (@Version)      â”‚   â”‚  Relation conceptuelle
â”‚ updated_at              â”‚   â”‚  (pas de FK rÃ©elle)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     RESERVATION         â”‚   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ id (PK, auto)           â”‚   â”‚
â”‚ event_id                â”‚â”€â”€â”€â”˜
â”‚ user_id                 â”‚
â”‚ quantity                â”‚
â”‚ status (enum)           â”‚â”€â”€â”€â”€â”€â”€â”€â”
â”‚ hold_expires_at         â”‚       â”‚  RÃ©fÃ©rence lors de
â”‚ created_at              â”‚       â”‚  la confirmation
â”‚ updated_at              â”‚       â”‚
â”‚ idempotency_key (unique)â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚        TICKET           â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚ id (PK, auto)           â”‚       â”‚
â”‚ reservation_id          â”‚â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ user_id                 â”‚
â”‚ event_id                â”‚
â”‚ quantity                â”‚
â”‚ created_at              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Index:
- reservation: user_id, event_id, status, idempotency_key
- ticket: reservation_id, user_id, event_id
```

---

## ğŸ” SÃ©curitÃ© (TODO Production)

### Configuration Actuelle (Dev)

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http
            .csrf(disable)                 // â† REST stateless
            .authorizeHttpRequests(auth ->
                auth.anyRequest().permitAll()  // â† DEV ONLY
            );
    }
}
```

### Configuration Production (TODO)

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http
            .csrf(disable)
            .oauth2ResourceServer(oauth2 ->
                oauth2.jwt(jwt -> jwt.decoder(jwtDecoder()))
            )
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/swagger-ui/**").permitAll()
                .anyRequest().authenticated()  // â† PROD
            );
    }
}
```

---

Cette documentation visuelle couvre tous les aspects architecturaux ! ğŸ‰
