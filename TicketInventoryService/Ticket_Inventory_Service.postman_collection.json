{
  "info": {
    "name": "Ticket Inventory Service API",
    "description": "Collection complète pour tester le Ticket Inventory Service",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8082",
      "type": "string"
    },
    {
      "key": "eventId",
      "value": "1",
      "type": "string"
    },
    {
      "key": "userId",
      "value": "1",
      "type": "string"
    },
    {
      "key": "reservationId",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "INT-019 - Consulter disponibilité",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has required fields', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('eventId');",
              "    pm.expect(jsonData).to.have.property('total');",
              "    pm.expect(jsonData).to.have.property('reserved');",
              "    pm.expect(jsonData).to.have.property('available');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/tickets/availability/{{eventId}}",
          "host": ["{{base_url}}"],
          "path": ["tickets", "availability", "{{eventId}}"]
        },
        "description": "Vérifie la disponibilité des tickets pour un événement"
      },
      "response": []
    },
    {
      "name": "INT-016 - Réserver des tickets",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has reservationId', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('reservationId');",
              "    pm.expect(jsonData.status).to.eql('PENDING');",
              "    ",
              "    // Save reservationId for next requests",
              "    pm.collectionVariables.set('reservationId', jsonData.reservationId);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Idempotency-Key",
            "value": "test-reservation-{{$timestamp}}",
            "description": "Clé unique pour l'idempotence"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"eventId\": {{eventId}},\n  \"userId\": {{userId}},\n  \"quantity\": 3\n}"
        },
        "url": {
          "raw": "{{base_url}}/tickets/reserve",
          "host": ["{{base_url}}"],
          "path": ["tickets", "reserve"]
        },
        "description": "Crée une réservation temporaire de tickets"
      },
      "response": []
    },
    {
      "name": "INT-020 - Réservations utilisateur",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has reservations array', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('userId');",
              "    pm.expect(jsonData).to.have.property('reservations');",
              "    pm.expect(jsonData.reservations).to.be.an('array');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/tickets/user/{{userId}}",
          "host": ["{{base_url}}"],
          "path": ["tickets", "user", "{{userId}}"]
        },
        "description": "Récupère toutes les réservations d'un utilisateur"
      },
      "response": []
    },
    {
      "name": "INT-017 - Confirmer réservation",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Reservation is confirmed', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('CONFIRMED');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"reservationId\": {{reservationId}}\n}"
        },
        "url": {
          "raw": "{{base_url}}/tickets/confirm",
          "host": ["{{base_url}}"],
          "path": ["tickets", "confirm"]
        },
        "description": "Confirme une réservation en attente"
      },
      "response": []
    },
    {
      "name": "INT-018 - Annuler réservation",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Reservation is canceled', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('CANCELED');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"reservationId\": {{reservationId}}\n}"
        },
        "url": {
          "raw": "{{base_url}}/tickets/release",
          "host": ["{{base_url}}"],
          "path": ["tickets", "release"]
        },
        "description": "Annule une réservation et libère les tickets"
      },
      "response": []
    },
    {
      "name": "❌ Stock insuffisant",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 409 (Conflict)', function () {",
              "    pm.response.to.have.status(409);",
              "});",
              "",
              "pm.test('Error message contains INSUFFICIENT_STOCK', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.error).to.include('INSUFFICIENT');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Idempotency-Key",
            "value": "test-error-{{$timestamp}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"eventId\": {{eventId}},\n  \"userId\": 99,\n  \"quantity\": 500\n}"
        },
        "url": {
          "raw": "{{base_url}}/tickets/reserve",
          "host": ["{{base_url}}"],
          "path": ["tickets", "reserve"]
        },
        "description": "Test d'erreur : demande plus de tickets que disponible"
      },
      "response": []
    },
    {
      "name": "❌ Réservation inexistante",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 404 (Not Found)', function () {",
              "    pm.response.to.have.status(404);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"reservationId\": 99999\n}"
        },
        "url": {
          "raw": "{{base_url}}/tickets/confirm",
          "host": ["{{base_url}}"],
          "path": ["tickets", "confirm"]
        },
        "description": "Test d'erreur : confirmation d'une réservation inexistante"
      },
      "response": []
    },
    {
      "name": "❌ Événement inexistant",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 404 (Not Found)', function () {",
              "    pm.response.to.have.status(404);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/tickets/availability/99999",
          "host": ["{{base_url}}"],
          "path": ["tickets", "availability", "99999"]
        },
        "description": "Test d'erreur : disponibilité d'un événement inexistant"
      },
      "response": []
    },
    {
      "name": "✅ Test Idempotence",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "// Save first reservationId",
              "if (!pm.collectionVariables.get('idempotence_test_id')) {",
              "    var jsonData = pm.response.json();",
              "    pm.collectionVariables.set('idempotence_test_id', jsonData.reservationId);",
              "    console.log('First request - Saved ID: ' + jsonData.reservationId);",
              "} else {",
              "    // Second request should return same ID",
              "    var jsonData = pm.response.json();",
              "    var savedId = pm.collectionVariables.get('idempotence_test_id');",
              "    pm.test('Same reservationId returned', function () {",
              "        pm.expect(jsonData.reservationId).to.eql(parseInt(savedId));",
              "    });",
              "    console.log('Second request - Received ID: ' + jsonData.reservationId);",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Idempotency-Key",
            "value": "idempotence-test-key-123",
            "description": "Clé fixe pour tester l'idempotence"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"eventId\": {{eventId}},\n  \"userId\": 77,\n  \"quantity\": 1\n}"
        },
        "url": {
          "raw": "{{base_url}}/tickets/reserve",
          "host": ["{{base_url}}"],
          "path": ["tickets", "reserve"]
        },
        "description": "Exécutez cette requête 2 fois avec la même clé - Vous devriez obtenir le même reservationId"
      },
      "response": []
    }
  ]
}
